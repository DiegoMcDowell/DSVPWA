name: CI/CD con SAST y DAST para DSVPWA

on: [push, pull_request]

jobs:
  sast:
    runs-on: self-hosted

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v3

      - name: Instalar dependencias
        run: |
          pip install bandit pylint

      - name: Analizar con Bandit
        run: bandit -r dsvpwa -f html -o bandit_report.html || true

      - name: Analizar con Pylint
        run: pylint dsvpwa/*.py || true

      - name: Ejecutar SonarQube Scanner (local)
        run: sonar-scanner || true

      - name: Subir reporte Bandit
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit_report.html

  dast:
    runs-on: self-hosted
    needs: sast

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v3

      - name: Verificar si imagen Docker ya existe
        run: |
          if ! docker image inspect dsvpwa > /dev/null 2>&1; then
            echo "üõ† Construyendo imagen 'dsvpwa'..."
            docker build -t dsvpwa .
          else
            echo "‚úÖ Imagen 'dsvpwa' ya existe. Skipping build."
          fi

      - name: Verificar si algo ya est√° usando el puerto 65413
        run: |
          if lsof -i :65413 | grep LISTEN > /dev/null; then
            echo "‚úÖ Ya hay algo corriendo en el puerto 65413. Us√°ndolo."
          else
            echo "üöÄ Nada en el puerto, lanzando contenedor..."
            docker run -d --name vulnerable-app -p 65413:65413 dsvpwa
          fi

      - name: Esperar que la app est√© en l√≠nea
        run: |
          echo "‚åõ Esperando que la app responda..."
          for i in $(seq 1 10); do
            if curl -s http://localhost:65413 | grep "DOCTYPE" > /dev/null; then
              echo "‚úî Aplicaci√≥n en l√≠nea"
              exit 0
            fi
            echo "Esperando..."
            sleep 2
          done
          echo "‚ùå La aplicaci√≥n no respondi√≥ a tiempo"
          exit 1

      - name: Ejecutar ZAP desde instalaci√≥n local
        run: |
          /Applications/ZAP.app/Contents/MacOS/ZAP.sh \
            -cmd -quickurl http://localhost:65413 \
            -quickout zap_report.html -quickprogress || true

      - name: Verificar reporte ZAP
        run: |
          if [ -f zap_report.html ]; then
            echo "‚úî Reporte ZAP generado correctamente"
          else
            echo "‚ùå Reporte ZAP NO generado"
            exit 1
          fi

      - name: Subir artefacto ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap_report.html
