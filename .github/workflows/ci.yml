name: CI/CD con SAST y DAST para DSVPWA

on: [push, pull_request]

jobs:
  sast:
    name: Análisis Estático con herramientas locales
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3

      - name: Instalar dependencias Python
        run: |
          pip install bandit pylint

      - name: Ejecutar Bandit
        run: bandit -r dsvpwa -f html -o bandit_report.html || true

      - name: Ejecutar Pylint
        run: pylint dsvpwa/*.py || true

      - name: Ejecutar SonarQube Scanner local
        run: sonar-scanner || true

      - name: Subir reporte Bandit
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit_report.html

  dast:
    name: Análisis Dinámico con ZAP local
    runs-on: self-hosted
    needs: sast
    steps:
      - uses: actions/checkout@v3

      - name: Levantar app vulnerable
        run: |
          docker build -t dsvpwa .
          docker run -d -p 65413:65413 --name vulnerable-app dsvpwa
          sleep 10

      - name: Ejecutar ZAP desde instalación local
        run: |
          /Applications/ZAP.app/Contents/MacOS/ZAP.sh \
            -cmd \
            -quickurl http://127.0.0.1:65413 \
            -quickout zap_report.html \
            -quickprogress || true

      - name: Subir reporte ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap_report.html

      - name: Detener app vulnerable
        run: docker stop vulnerable-app
